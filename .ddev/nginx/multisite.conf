# Multisite rewrite rules for WordCamp.org
# Adapted from .docker/config/nginx.conf

# Rewrite ms-files for uploaded media.
rewrite ^/files/(.*)$ /wp-includes/ms-files.php?file=$1;

# Rewrite multisite subdirectory paths (e.g., /2023/wp-admin/).
if (!-e $request_filename) {
    rewrite ^/[_0-9a-zA-Z-]+(/wp-.*) $1 last;
    rewrite ^/[_0-9a-zA-Z-]+.*(/wp-admin/.*\.php)$ $1 last;
    rewrite ^/[_0-9a-zA-Z-]+(/.*\.php)$ $1 last;
    rewrite "/\d{4}/files/(.+)$" /wp-includes/ms-files.php?file=$1 last;
}

# Events network 3-level path rewrites (e.g., /rome/2024/training/wp-admin/).
if ( $host = "events.wordpress.test" ) {
    rewrite "/[\w-]+/\d{4}/[\w-]+/wp-(admin|content|includes)(.*)" /wp-$1$2 last;
    rewrite "/[\w-]+/\d{4}/[\w-]+/wp-(.*).php(.*)" /wp-$1.php$2 last;
    rewrite "/[\w-]+/\d{4}/[\w-]+/xmlrpc\.php" /xmlrpc.php last;
    rewrite "/[\w-]+/\d{4}/[\w-]+/files/(.+)$" /wp-includes/ms-files.php?file=$1 last;
}

# Serve wp-content from the parent directory (public_html/, not public_html/mu/).
location ~* /wp-content/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
    root /var/www/html/public_html;
    expires max;
    log_not_found off;
}
